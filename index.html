<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Financial Inaccessibility of PrEP </title>
    
    <link rel="preconnect" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin-left:30px;
            margin-right:30px;
            margin-top:50px;
        }
        
        b {
            font-weight:400;
        }
        h1, h3 {font-family:"Roboto"; line-height:0.2em;}
        h1 {font-weight:300}
        h3 {font-weight:400}
        .subtitle {font-size: 22px; font-family:roboto; font-weight:100}
        .body-text {font-size: 18px; font-family:roboto; font-weight:100}
        rect{stroke:white; stroke-width:2}
        text{font-family:roboto; font-weight:300}
        line{stroke:white; opacity: 50%}
        .scroll-button{
            background-color: white;
            border: 1px solid black;
            font-family:roboto;
            font-weight:300;
            font-size:1em;
            width:100%;
            margin: 0 auto;
            padding:5px;
            margin-top:20px;
            border-radius:20px;
            max-width:250px;
            min-width:100px;
        }
        .toggle-button {
            background-color: #ECA285;
            border: 1px solid black;
            font-family:roboto;
            font-weight:300;
            font-size:1em;
            display:block;
            width:100%;
            margin: 0 auto;
            padding:5px;
            margin-top:20px;
            border-radius:20px;
            max-width:250px;
            min-width:100px;
        }
        
        .toggle-button-county {

            border: 1px solid black;
            font-family:roboto;
            font-weight:300;
            font-size:1em;
            display:block;
            width:100%;
            margin: 0 auto;
            padding:5px;
            margin-top:20px;
            border-radius:20px;
            max-width:250px
        }
        
        button.active {
            background-color:#134e13;
            color:white;
            font-weight:800;
             
        }
        
        button.inactive {
            background-color:white;
            color:black;
            font-weight:300;
        }
    
        #outermost, #outermost-county {
            display:flex;
            align-items:center;
    
        }
        
        #scrolling {
            align-items:center;
            display: flex;
            margin: 0 auto;
            min-width:250px;
            flex:1;

    
        }
        #ratio-map {
            flex: 5;
        }
        #text-and-buttons {
            margin:20px;
            flex:1;
        }
        
        #ratio-buttons {
            width:75%;
            margin: 0 auto;
        }
        
        #button-title {
            text-align:center;
            min-width:250px;
        }
    
        #text-and-buttons-county {
            margin:20px;
            flex:1;
        }
        
        #ratio-buttons-county {
            width:75%;
            margin: 0 auto;
        }
        
        #button-title-county {
            text-align:center;
            min-width:300px;
        }
        
        
        
    </style>
    
</head>
    
<script src="https://d3js.org/d3.v6.min.js"></script>

<script>

    //read in States data
    d3.json("us_states.json").then((states) => {
        console.log(states.features);
      
    //create svg
    const svg = d3.select("#ratio-map")
            .attr("id", "prep")
            .attr("width", 900)
            .attr("height", 800)
   
    //text
  const didExpand = svg.append("text")
        .text("Expanded Medicaid")
        .attr("x", 0)
        .attr("y", 200)
        .style("opacity", 0)
  
    const didNotExpand = svg.append("text")
        .text("Did not expand Medicaid")
        .attr("x", 0)
        .attr("y", 600)
        .style("opacity", 0)
    
    const yesDap = svg.append("text")
        .text("Has a PrEP-DAP")
        .attr("x", 0)
        .attr("y", 200)
        .style("opacity", 0)
    
    const noDap = svg.append("text")
        .text("Does not have a PrEP-DAP")
        .attr("x", 0)
        .attr("y", 600)
        .style("opacity", 0)
    
    
    
    //create path
    const projection = d3.geoAlbersUsa().scale(800)
    const pathGenerator = d3.geoPath().projection(projection);
    
    const statePaths = svg.selectAll(".state-path")
        .data(states.features)
        .join("path")
        .attr("class", "state-path")
        .attr("d", pathGenerator)
        .attr("transform", "translate(-40, 125)")
    
    statePaths.attr("stroke", "white")
        
    //read in state PnR csv
    
        d3.csv('AIDSVu_State_PNR_2018.csv').then(statesCsv => {

        //loop through json and csv
        for (i=0; i<statesCsv.length; i++) {
            let currentCsvState = statesCsv[i].state;
            
            let pnr2018 = +statesCsv[i].state_pnr;
            let medicaid = statesCsv[i].med_expansion;
            let pdap = statesCsv[i].dap;
            let hiv18 = statesCsv[i].hiv2018;
            
            for(j = 0; j<states.features.length; j++) {
                let currentJsonState = states.features[j].properties.NAME;
                
                if (currentJsonState == currentCsvState) {
                    states.features[j].properties.state_pnr = pnr2018;
                    states.features[j].properties.med_expansion = medicaid;
                    states.features[j].properties.dap = pdap;
                    states.features[j].properties.hiv2018 = hiv18;
                }
            }
        }
        console.log(states);    
        
        //color by medicaid expansion
        
            
        //mouseover
        statePaths.on("mouseover", function() {
            d3.select(this).style("opacity", 0.5);
            const thisData = d3.select(this).data()[0];
            tooltip.style("opacity", 1);
            stateNameSpan.text(thisData.properties.NAME);
            spanPnr.text(thisData.properties.state_pnr);
            spanHIV.text(thisData.properties.hiv2018); 
        })
            .on("mouseout", function(){
                d3.select(this).style("opacity", 1)
                tooltip.style("opacity",0)
        })
            .on("mousemove", function(event){
            tooltip.style("left", d3.pointer(event)[0] + "px")
            tooltip.style("top", d3.pointer(event)[1] +350 + "px")

        })
            
            //tooltip
        const tooltip = d3.select("body").append("div")
            .attr("id", "tooltip")
            .style("border", "1px solid black")
            .style("padding", "10px")
            .style("position", "absolute")
            .style("opacity", 0)
            .style("background-color", "white")
            .style("font-family", "roboto")
            .style("font-weight", "300")
            .style("pointer-events", "none");
            
            let ctStateName = tooltip.append("div")
                    .text("State name: ")
            
            let ctPnr = tooltip.append("div")
                    .text("PrEP-to-Need Ratio: ")
            
            let ctHIVdiag = tooltip.append("div")
                    .text("New HIV Diagnoses in 2018: ")
            
            let stateNameSpan = ctStateName.append("span")
                    .text("Virginia")
            
            let spanPnr = ctPnr.append("span")
                    .text("Virginia")
            
            let spanHIV = ctHIVdiag.append("span")
                    .text("Virginia")
            
    //color by PNR  
    colorScale = d3.scaleLinear()
            .domain([0, 15])
            .range(["#ca0020", "#ffffbf"])
    
    statePaths.style("fill", d => colorScale(d.properties.state_pnr))
         
    //HANDLE BUTTONS
        const medicaidButton = d3.select("button#medicaid")
        const dapButton = d3.select("button#dap")
        const clearButton = d3.select("button#clear")
        const scrollButton = d3.select("button#scroll")
            
            medicaidButton.on("click", function() {
                console.log(statePaths)
                statePaths.transition().duration(500).attr("transform", d=> d.properties.med_expansion == 0 ? "translate(-50, 350)" : "translate(-50,0)");
                didExpand.transition().duration(500).style("opacity", 1)
                didNotExpand.transition().duration(500).style("opacity", 1)
                yesDap.transition().duration(500).style("opacity", 0)
                noDap.transition().duration(500).style("opacity", 0)


            })

            clearButton.on("click", function() {
                statePaths.transition().duration(500).attr("transform", "translate(-40, 125)")
                didExpand.transition().duration(500).style("opacity", 0)
                didNotExpand.transition().duration(500).style("opacity", 0)
                yesDap.transition().duration(500).style("opacity", 0)
                noDap.transition().duration(500).style("opacity", 0)
                    })
            
            dapButton.on("click", function() {
                console.log("Inside dap")
                statePaths.transition().duration(500).attr("transform", d=> d.properties.dap == 0 ? "translate(-50, 350)" : "translate(-50,0)");
                didExpand.transition().duration(500).style("opacity", 0)
                didNotExpand.transition().duration(500).style("opacity", 0)
                yesDap.transition().duration(500).style("opacity", 1)
                noDap.transition().duration(500).style("opacity", 1)

            })
            
            scrollButton.on("click", function() {
            }) 
            
        
        })
    
   
        
        })
     //insurance, education, poverty, pnr
    let currentDeterminant = "insurance"
    
    //pct_uninsured, pct_poverty, pct_hsed, county_pnr
    const detMap = {insurance:'pct_uninsured', education:'pct_hsed', poverty:'pct_poverty', pnr:'county_pnr', prevalence: 'prev_rate', black_prevalence: 'black_prev_rate'};
    
    //read in States data
    d3.json("us_counties.json").then((counties) => {
        console.log(counties.features);
        
    
    for (i=0; i<counties.features.length; i++) {
        counties.features[i].properties['fips'] = counties.features[i].properties.GEO_ID.slice(9)
    }
    console.log(counties)

              
    //create svg
    const svg = d3.select("#county-map")
            .attr("id", "soh")
            .attr("width", 800)
            .attr("height", 600)
    
        //create path
    const projection = d3.geoAlbersUsa().scale(800)
    const pathGenerator = d3.geoPath().projection(projection);
    

    
    const countyPaths = svg.selectAll(".county-path")
        .data(counties.features)
        .join("path")
        .attr("class", "county-path")
        .attr("d", pathGenerator)
        .attr("transform", "translate(-40, 80)")

    
    countyPaths.attr("stroke", "white")
    countyPaths.attr("stroke-width", 0.3)
    
    d3.csv('AIDSVu_County_SDOH_2018.csv').then(countiesCsv => {


        //loop through json and csv
        for (i=0; i<countiesCsv.length; i++) {
            let currentCsvCounty = countiesCsv[i].geoid;
            
            let insurance = +countiesCsv[i].pct_uninsured;
            let poverty = +countiesCsv[i].pct_poverty;
            let hs_educ = +countiesCsv[i].pct_hsed;
            let syph = +countiesCsv[i].syphillis_rate;
            let countypnr = +countiesCsv[i].county_pnr;
            let prevalence = +countiesCsv[i].prev_rate;
            let black_prevalence = +countiesCsv[i].black_prev_rate;
            let countyname = countiesCsv[i].county;
            let state = countiesCsv[i].state;
            
            for(j = 0; j<counties.features.length; j++) {
                let currentJsonCounty = counties.features[j].properties.fips;
                
                if (currentJsonCounty == currentCsvCounty) {
                    counties.features[j].properties.pct_uninsured = insurance;
                    counties.features[j].properties.pct_poverty = poverty;
                    counties.features[j].properties.pct_hsed = hs_educ;
                    counties.features[j].properties.syphillis_rate = syph;
                    counties.features[j].properties.county_pnr = countypnr;
                    counties.features[j].properties.prev_rate = prevalence;
                    counties.features[j].properties.black_prev_rate = black_prevalence;
                    counties.features[j].properties.county = countyname;
                    counties.features[j].properties.state = state;

                }
            }
        }
        console.log(counties); 
        
        //color by uninsured
        
           //color by pct uninsured    
    colorScaleInsurance = d3.scaleLinear()
            .domain([0, 33])
            .range(["#ffeb49", "#134e13"])
    
    countyPaths.style("fill", d => colorScaleInsurance(d.properties.pct_uninsured))
    const unitsMap = {
        insurance:'%', 
        education:'%', 
        poverty:'%', 
        pnr:'%', 
        prevalence: ' of 100k', 
        black_prevalence: ' of 100k'};
    //mouseover
        countyPaths.on("mouseover", function() {
            d3.select(this).style("opacity", 0.5);
            const thisData = d3.select(this).data()[0];
            tooltipCounty.style("opacity", 1);
            countyNameSpan.text(thisData.properties.county);
            spanCountySt.text(thisData.properties.state);
            spanUninsured.text(thisData.properties[detMap[currentDeterminant]] + unitsMap[currentDeterminant]); 
            
        }) 
            .on("mouseout", function(){
                d3.select(this).style("opacity", 1)
                tooltipCounty.style("opacity",0)
        })
            .on("mousemove", function(event){
            tooltipCounty.style("left", d3.pointer(event)[0] + "px")
            tooltipCounty.style("top", d3.pointer(event)[1] + 1400 + "px")
        })

        //tooltip
        const tooltipCounty = d3.select("body").append("div")
            .attr("id", "tooltip-county")
            .style("border", "1px solid black")
            .style("padding", "10px")
            .style("position", "absolute")
            .style("opacity", 1)
            .style("background-color", "white")
            .style("font-family", "roboto")
            .style("font-weight", "300")
            .style("pointer-events", "none");
            
            let ctCountyName = tooltipCounty.append("div")
                    .text("County name: ")
            
            let ctCountyState = tooltipCounty.append("div")
                    .text("State: ")
            
            let ctUninsuredDiv = tooltipCounty.append("div")
            
            let ctUninsured = ctUninsuredDiv.append("span")
                    .text("Percent Uninsurance: ")
            
            let countyNameSpan = ctCountyName.append("span")
                    .text("Virginia")
            
            let spanCountySt = ctCountyState.append("span")
                    .text("Virginia")
            
            let spanUninsured = ctUninsuredDiv.append("span")
                    .text("Virginia")
            
            
            
            
    //HANDLE BUTTONS
        const educationButton = d3.select("button#hsed")
        const uninsuranceButton = d3.select("button#uninsurance")
        const povertyButton = d3.select("button#poverty")
        const PnrButton = d3.select("button#pnr")
        const PrevalenceButton = d3.select("button#prevalence")
        const BlackPrevalenceButton = d3.select("button#black_prevalence")


        const clearCountyButton = d3.select("button#clear-county").style("display", "none")
        
        const resetButtonStyles = () => {
            educationButton.attr("class", "toggle-button inactive")
            uninsuranceButton.attr("class", "toggle-button inactive")
            povertyButton.attr("class", "toggle-button inactive")
            PnrButton.attr("class", "toggle-button inactive")
            PrevalenceButton.attr("class", "toggle-button inactive")
            BlackPrevalenceButton.attr("class", "toggle-button inactive")
        }
        
            const eduMin = 70;
            const povMax = 35;
            const pnrMax = 20;
            const prevMax = 1000;
            const blackPrevMax = 3000;

        
            babyEduScale = d3.scaleLinear()
                .domain([eduMin, 100])
                .range(["#ffeb49", "#134e13"])
            
            babyPovScale =  d3.scaleLinear()
                .domain([0, povMax])
                .range(["#ffeb49", "#134e13"])
        
            babyPnrScale =  d3.scaleLinear()
                .domain([0, pnrMax])
                .range(["#ffeb49", "#134e13"])
        
            babyPrevScale =  d3.scaleLinear()
                .domain([0, prevMax])
                .range(["#ffeb49", "#134e13"])
        
            babyBlackPrevScale =  d3.scaleLinear()
                .domain([0, blackPrevMax])
                .range(["#ffeb49", "#134e13"])        
        
        
            const colorScaleEdu = (val) => {
                if (val >= eduMin) {
                    return babyEduScale(val)
                } else {
                    return "#ffeb49"
                }
            }
        
            const colorScalePov = (val) => {
                if (val <= povMax) {
                    return babyPovScale(val)
                } else {
                    return "#134e13"
                }
            }
        
            const colorScalePnR = (val) => {
                if (val <= pnrMax) {
                    return babyPnrScale(val)
                } else {
                    return "#134e13"
                }
            }
            
        
            const colorScalePrev = (val) => {
                if (val <= prevMax) {
                    return babyPrevScale(val)
                } else {
                    return "#134e13"
                }
            }
            
            const colorScaleBlackPrev = (val) => {
                if (val <= blackPrevMax) {
                    return babyBlackPrevScale(val)
                } else {
                    return "#134e13"
                }
            }            
        
            //Pre-fill insurance button
            uninsuranceButton.attr("class", "toggle-button active")
            educationButton.attr("class", "toggle-button inactive")
            povertyButton.attr("class", "toggle-button inactive")
            PnrButton.attr("class", "toggle-button inactive")
            PrevalenceButton.attr("class", "toggle-button inactive")
            BlackPrevalenceButton.attr("class", "toggle-button inactive")
        
            educationButton.on("click", function() {
                currentDeterminant = "education"
                d3.select("#county-scale-start").text("70%")
                d3.select("#county-scale-end").text("100%")
                ctUninsured.text("% completed HS degree: ")
                
                resetButtonStyles()
                educationButton.attr("class", "toggle-button active")
                console.log(countyPaths)
                countyPaths.transition().duration(500).style("fill", d=> colorScaleEdu(d.properties.pct_hsed))
            })
            
            povertyButton.on("click", function() {
                currentDeterminant = "poverty"
                
                d3.select("#county-scale-start").text("0%")
                d3.select("#county-scale-end").text("35%")
                
                ctUninsured.text("% in poverty: ")
                resetButtonStyles()
                povertyButton.attr("class", "toggle-button active")
                console.log(countyPaths)
                countyPaths.transition().duration(500).style("fill", d=> colorScalePov(d.properties.pct_poverty))
            })
        
            uninsuranceButton.on("click", function() {
                currentDeterminant = "insurance"
                
                d3.select("#county-scale-start").text("0%")
                d3.select("#county-scale-end").text("33%")
                
                ctUninsured.text("% uninsured: ")
                resetButtonStyles()
                uninsuranceButton.attr("class", "toggle-button active")
                console.log(countyPaths)
                countyPaths.transition().duration(500).style("fill", d=> colorScaleInsurance(d.properties.pct_uninsured))
            })
        
            PrevalenceButton.on("click", function() {
                currentDeterminant = "prevalence"
                
                d3.select("#county-scale-start").text("0 of 100k")
                d3.select("#county-scale-end").text("1,000 of 100k")
                
                ctUninsured.text("HIV prevalence rate: ")
                resetButtonStyles()
                PrevalenceButton.attr("class", "toggle-button active")
                console.log(countyPaths)
                countyPaths.transition().duration(500).style("fill", d=> colorScalePrev(d.properties.prev_rate))
                console.log(PrevalenceButton)
            })    
        
           BlackPrevalenceButton.on("click", function() {
                d3.select("#county-scale-start").text("Ed lol")
                d3.select("#county-scale-end").text("Ed lo2l")
               
                currentDeterminant = "black_prevalence"
                ctUninsured.text("Black HIV prevalence rate: ")
                resetButtonStyles()
                BlackPrevalenceButton.attr("class", "toggle-button active")
                console.log(countyPaths)
                countyPaths.transition().duration(500).style("fill", d=> colorScaleBlackPrev(d.properties.black_prev_rate))
            })         
                
        })

        })
    
    //county-scale

        
    
     </script>
    
    <body>
    
    <h1>PrEP Financial Inaccessibility</h1>
    <p class  = "subtitle">2018 PrEP Utilization Relative to HIV Diagnosis (by state) </p>
 
    <p class = "body-text" id = "med_text"> U.S. states in 2018 that expanded Medicaid had a PnR that was more than <b>two times higher</b> (6.6) than states that did not expand Medicaid (3.1), indicating fewer PrEP users relative to the need for PrEP in non-Medicaid expansion states.</p>

    <p class = "body-text" id = "dap_text">Similarly, states with a PrEP-DAP had nearly <b>double the rate of PrEP use (100.6 PrEP users per 100,000 population) and double the PrEP-to-Need Ratio (6.4)</b> relative to states without such programs (51.9 PrEP users per 100,000 population and 3.9 PnR)</p>

    
        <div id = "scrolling">
        <div id = "outermost">
        <svg id = "ratio-map">
            
            <text id =  "ratio-scale-start" style = "text-anchor:end"  x = 590  y  = 90>0</text>
            <text id =  "ratio-scale-end" style = "text-anchor:start"  x = 690  y  = 90>15</text>
    <defs>
        <linearGradient id="state-map" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#ffffbf;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ca0020;stop-opacity:1" />
    </linearGradient>
  </defs>
  <rect x="600" y="70" height="30" width="80" fill="url(#state-map)" />  
            </svg>
        <div id = "text-and-buttons">    
            <h3 id = "button-title">Click to show states with:</h3>
            <div id = "ratio-buttons">    
                <button class = "toggle-button" id = "medicaid">Medicaid Expansion</button>
                <button class = "toggle-button" id = "dap">PrEP drug assistance programs (DAP)</button>
                <button class = "toggle-button" id = "clear">Clear all</button>
            </div>

        </div>

<svg height="50" width="100">

</svg>      
            
            
    </div>
 <!--<button class = "scroll-button" id = "scroll" href="#h1">Scroll down to social determinants of health</button> -->
</div>
        
        
        <h1 id = "#h1">Social Determinants of Health and PrEP disparities</h1>
        
    <p class = "body-text" id = "SOH_text"> This map reflects the geographic disparities across social determinants of health that are highly associated with PrEP usage. States in the South are <b>more likely to have higher rates of poverty and uninsurance and lower HS graduation rates.</b> The South mades up roughly 38% of the US population but accounts for <b>over 52% of new HIV diagnoses.</b></p> 
        
    <p class = "body-text" id = "SOH_text2">There is a <b>lower PrEP-usage</b> relative to PrEP need in states with higher rates of <b>poverty and lack of health insurance.</b>While not represented on the map given data limitations, research suggest that U.S. counties with the <b>highest proportion of Black residents</b> had <b>lower rates of PrEP use</b> relative to need than those with the lowest proportion.</p>
        
    <p class = "body-text" id = "SOH_text3">This data reveals an equity gap, where those with the <b>greatest need for PrEP are those with the lowest utilization.</b> It also suggests that the cost of PrEP and associated services remain one of the most salient barriers to accessing PrEP.</p>         
        
    <div id = "outermost-county">
        <svg id = "county-map">
            <text id =  "county-scale-start" style = "text-anchor:end"  x = 590  y  = 90>0%</text>
            <text id =  "county-scale-end" style = "text-anchor:start"  x = 690  y  = 90>33%</text>
          <defs>
            <linearGradient id="county-map" x1="0%" y1="0%" x2="100%" y2="0%" transform="translate(500, 0)">
              <stop offset="0%" style="stop-color:#ffeb49;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#134e13;stop-opacity:1" />
            </linearGradient>
  </defs>
  <rect x="600" y="70" height="30" width="80" fill="url(#county-map)" />
        </svg>
        <div id = "text-and-buttons-county">    
            <h3 id = "button-title-county">Click to show determinants by:</h3>
            <div id = "ratio-buttons-county">    
                <button class = "toggle-button-county" id = "uninsurance">Uninsurance Rates</button>
                <button class = "toggle-button-county" id = "hsed">High School Education</button>
                <button class = "toggle-button-county" id = "poverty">Percent in Poverty</button>
                <button class = "toggle-button-county" id = "prevalence">County HIV Prevalence Rate</button>
                <button class = "toggle-button-county" id = "clear-county">Clear all</button>
            </div>
            
        </div>
        
        <svg height="50" width="100">

</svg>   
    </div> 
        
    </body>
    
</html>